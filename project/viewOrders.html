<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách Đơn hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .order {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .order h4 {
            margin-top: 0;
        }
        .order ul {
            list-style-type: none;
            padding-left: 0;
        }
        .order ul li {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        .order ul li img {
            width: 50px;
            height: 50px;
            margin-right: 10px;
        }
        .order .product-details {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h3 class="text-center mb-4">Danh sách Đơn hàng</h3>
        <div id="orders-list">
            <!-- Các đơn hàng sẽ được hiển thị ở đây -->
        </div>
    </div>
   
    <script>
        async function loadOrders() {
    try {
        // Thay đổi URL API cho đúng
        const response = await fetch('http://localhost:3004/orders/admin');
        if (response.ok) {
            const orders = await response.json();
            // Gọi hàm displayOrders để hiển thị đơn hàng
            displayOrders(orders);
        } else {
            console.error('Không thể lấy đơn hàng, mã lỗi:', response.status);
        }
    } catch (error) {
        console.error('Lỗi khi gọi API:', error);
    }
}

function displayOrders(orders) {
    const orderContainer = document.getElementById('orders-list');
    orderContainer.innerHTML = '';  // Xóa nội dung cũ

    if (orders.length === 0) {
        orderContainer.innerHTML = '<p class="no-items">Không có đơn hàng nào.</p>';
    } else {
        orders.forEach(order => {
            let statusClass = '';
            switch(order.status) {
                case 'Pending':
                    statusClass = 'status-pending';
                    break;
                case 'Processed':
                    statusClass = 'status-processed';
                    break;
                case 'Shipped':
                    statusClass = 'status-shipped';
                    break;
                case 'Cancelled':
                    statusClass = 'status-cancelled';
                    break;
            }

            const orderCard = `
                <div class="order">
                    <h4>Đơn hàng #${order._id}</h4>
                    <p><strong>Người nhận:</strong> ${order.fullName}</p>
                    <p><strong>Email:</strong> ${order.email}</p>
                    <p><strong>Điện thoại:</strong> ${order.phone}</p>
                    <p><strong>Địa chỉ:</strong> ${order.address}</p>
                    <p><strong>Phương thức thanh toán:</strong> ${order.paymentMethod}</p>
                    <p><strong>Tổng tiền:</strong> ${order.totalAmount ? order.totalAmount.toLocaleString() : 'N/A'} VND</p>
                    <p><strong>Trạng thái:</strong> <span class="${statusClass}">${order.status}</span></p>
                    <p><strong>Ngày tạo:</strong> ${new Date(order.createdAt).toLocaleString()}</p>

                    <h6>Sản phẩm:</h6>
                    <ul>
                        ${order.items.map(item => `
                            <li>
                                <img src="${item.productId.image || 'default-image.jpg'}" alt="${item.productId.name}">
                                <div>
                                    <strong>${item.productId.name}</strong> (x${item.quantity}) - 
                                    ${item.productId.price ? item.productId.price.toLocaleString() : 'N/A'} VND
                                </div>
                            </li>
                        `).join('')}
                    </ul>

                    <select id="status-${order._id}" class="form-select select-status">
                        <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Chờ duyệt</option>
                        <option value="Processed" ${order.status === 'Processed' ? 'selected' : ''}>Đã xử lý</option>
                        <option value="Shipped" ${order.status === 'Shipped' ? 'selected' : ''}>Đã giao</option>
                        <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Đã hủy</option>
                    </select>

                    <div class="d-flex justify-content-between">
                        <button class="btn btn-warning" onclick="updateStatus('${order._id}')">Cập nhật trạng thái</button>
                        <button class="btn btn-danger" onclick="cancelOrder('${order._id}')">Hủy đơn</button>
                    </div>
                </div>
            `;
            orderContainer.innerHTML += orderCard;  // Thêm đơn hàng vào container
        });
    }
}



// Gọi hàm khi trang tải
document.addEventListener('DOMContentLoaded', function() {
    loadOrders();
});

        // Hủy đơn hàng
        async function cancelOrder(orderId) {
            const token = localStorage.getItem('token');

            if (!token) {
                alert('Không tìm thấy token. Vui lòng đăng nhập lại.');
                window.location.href = 'login.html'; // Chuyển hướng đến trang đăng nhập
                return;
            }

            try {
                const response = await fetch(`http://localhost:3004/orders/admin/cancel/${orderId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}` // token admin
                    }
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message); // Hiển thị thông báo thành công
                    loadOrders(); // Reload lại danh sách đơn hàng
                } else {
                    alert(result.message); // Hiển thị lỗi nếu có
                }
            } catch (error) {
                console.error('Lỗi khi hủy đơn hàng:', error);
                alert('Đã xảy ra lỗi khi hủy đơn hàng.');
            }
        }

        // Cập nhật trạng thái đơn hàng
       // Cập nhật trạng thái đơn hàng
async function updateStatus(orderId) {
    const status = document.getElementById(`status-${orderId}`).value;

    try {
        const response = await fetch(`http://localhost:3004/orders/admin/${orderId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status })
        });

        const result = await response.json();
        if (response.ok) {
            alert(`Trạng thái đơn hàng đã được cập nhật: ${result.order.status}`);
            loadOrders(); // Tải lại danh sách đơn hàng
        } else {
            alert(`Lỗi: ${result.message}`);
        }
    } catch (error) {
        console.error('Lỗi khi cập nhật trạng thái:', error);
        alert('Đã xảy ra lỗi khi cập nhật trạng thái');
    }
}

        // Gọi hàm loadOrders khi trang được tải
        loadOrders();
    </script>
</body>
</html>
